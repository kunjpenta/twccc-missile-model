<!-- Threat Board CSV Export — Compact, Accessible Rewrite -->

<!-- Simple quick link (kept) -->
<a
  class="btn btn-sm btn-outline-primary"
  href="/api/tewa/export/threat_board.csv?scenario_id={{ scenario.id }}{% if da %}&da_id={{ da.id }}{% endif %}&top_n=50"
>
  Export Top 50
</a>

<section class="tbx">
  <header class="tbx__row">
    <div class="tbx__col">
      <label class="tbx__label" for="tbx-scenario">Scenario</label>
      <input class="tbx__input" id="tbx-scenario" value="{{ scenario.id }}" readonly aria-readonly="true" />
    </div>

    <div class="tbx__col">
      <label class="tbx__label" for="tbx-da">DA</label>
      <input class="tbx__input" id="tbx-da" value="{% if da %}{{ da.id }}{% endif %}" placeholder="(all)" />
    </div>

    <div class="tbx__col">
      <label class="tbx__label" for="tbx-at">at (UTC, ISO-8601)</label>
      <input class="tbx__input" id="tbx-at" placeholder="2025-10-15T05:42:50Z" inputmode="text" />
    </div>

    <div class="tbx__col">
      <label class="tbx__label" for="tbx-topn">Top N</label>
      <select class="tbx__input" id="tbx-topn" aria-label="Top N rows">
        <option value="">All</option>
        <option>10</option>
        <option>25</option>
        <option selected>50</option>
        <option>100</option>
        <option>200</option>
      </select>
    </div>

    <div class="tbx__actions">
      <button type="button" class="tbx__btn" id="tbx-export" aria-label="Export CSV">Export CSV</button>
      <button type="button" class="tbx__btn tbx__btn--ghost" id="tbx-fields" aria-haspopup="dialog" aria-controls="tbx-modal">Fields…</button>
    </div>
  </header>

  <div class="tbx__subrow">
    <div id="tbx-status" class="tbx__status" role="status" aria-live="polite"></div>
    <div class="tbx__right">
      <label class="tbx__check">
        <input type="checkbox" id="tbx-use-fields" /> Use custom fields
      </label>
      <span id="tbx-fields-summary" class="tbx__summary"></span>
    </div>
  </div>
</section>

<!-- Fields Modal -->
<div id="tbx-modal" class="tbx-modal" role="dialog" aria-modal="true" aria-labelledby="tbx-modal-title" hidden>
  <div class="tbx-modal__card" tabindex="-1">
    <div class="tbx-modal__head">
      <h3 id="tbx-modal-title">Select CSV Columns</h3>
      <button class="tbx-modal__icon" id="tbx-close" aria-label="Close fields selector">✕</button>
    </div>

    <div class="tbx-modal__body">
      <fieldset class="tbx-grid" id="tbx-fieldset" aria-label="CSV Columns">
        <!-- Default columns -->
        <label class="tbx__check"><input type="checkbox" data-col value="scenario_id" checked /> scenario_id</label>
        <label class="tbx__check"><input type="checkbox" data-col value="da_id" checked /> da_id</label>
        <label class="tbx__check"><input type="checkbox" data-col value="track_id" checked /> track_id</label>
        <label class="tbx__check"><input type="checkbox" data-col value="computed_at" checked /> computed_at</label>
        <label class="tbx__check"><input type="checkbox" data-col value="score" checked /> score</label>

        <label class="tbx__check"><input type="checkbox" data-col value="cpa_m" checked /> cpa_m</label>
        <label class="tbx__check"><input type="checkbox" data-col value="tcpa_s" checked /> tcpa_s</label>
        <label class="tbx__check"><input type="checkbox" data-col value="tdb_s" checked /> tdb_s</label>
        <label class="tbx__check"><input type="checkbox" data-col value="twrp_s" checked /> twrp_s</label>

        <label class="tbx__check"><input type="checkbox" data-col value="norm_cpa" checked /> norm_cpa</label>
        <label class="tbx__check"><input type="checkbox" data-col value="norm_tcpa" checked /> norm_tcpa</label>
        <label class="tbx__check"><input type="checkbox" data-col value="norm_tdb" checked /> norm_tdb</label>
        <label class="tbx__check"><input type="checkbox" data-col value="norm_twrp" checked /> norm_twrp</label>

        <label class="tbx__check"><input type="checkbox" data-col value="w_cpa" checked /> w_cpa</label>
        <label class="tbx__check"><input type="checkbox" data-col value="w_tcpa" checked /> w_tcpa</label>
        <label class="tbx__check"><input type="checkbox" data-col value="w_tdb" checked /> w_tdb</label>
        <label class="tbx__check"><input type="checkbox" data-col value="w_twrp" checked /> w_twrp</label>

        <label class="tbx__check"><input type="checkbox" data-col value="contrib_cpa" checked /> contrib_cpa</label>
        <label class="tbx__check"><input type="checkbox" data-col value="contrib_tcpa" checked /> contrib_tcpa</label>
        <label class="tbx__check"><input type="checkbox" data-col value="contrib_tdb" checked /> contrib_tdb</label>
        <label class="tbx__check"><input type="checkbox" data-col value="contrib_twrp" checked /> contrib_twrp</label>
      </fieldset>
    </div>

    <div class="tbx-modal__foot">
      <button class="tbx__btn" id="tbx-apply">Apply</button>
      <button class="tbx__btn tbx__btn--ghost" id="tbx-reset">Reset</button>
    </div>
  </div>
</div>

<style>
  :root{
    --tbx-bg:#10141c; --tbx-panel:#0f131b; --tbx-border:#22293a; --tbx-text:#e7e9ee; --tbx-muted:#9aa3b2; --tbx-accent:#4da3ff;
  }
  .tbx{background:var(--tbx-bg);border:1px solid var(--tbx-border);border-radius:14px;padding:12px;margin:10px 0;color:var(--tbx-text)}
  .tbx__row{display:grid;gap:10px;grid-template-columns:repeat(5,minmax(0,1fr));align-items:end}
  .tbx__subrow{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .tbx__right{display:flex;align-items:center;gap:10px}
  .tbx__col{display:flex;flex-direction:column}
  .tbx__label{font-size:12px;color:var(--tbx-muted);margin:0 0 6px}
  .tbx__input{height:36px;border:1px solid var(--tbx-border);background:#0d1118;color:var(--tbx-text);border-radius:10px;padding:0 10px;outline:0}
  .tbx__input:focus{border-color:var(--tbx-accent);box-shadow:0 0 0 2px color-mix(in srgb, var(--tbx-accent) 30%, transparent)}
  .tbx__actions{display:flex;gap:8px;justify-content:flex-end}
  .tbx__btn{height:36px;border-radius:10px;border:1px solid var(--tbx-accent);background:var(--tbx-accent);color:#081322;font-weight:600;padding:0 12px;cursor:pointer}
  .tbx__btn--ghost{background:transparent;color:var(--tbx-accent)}
  .tbx__status,.tbx__summary{font-size:12px;color:var(--tbx-muted)}
  .tbx__check{display:flex;align-items:center;gap:8px;font-size:14px}
  @media (max-width:1000px){.tbx__row{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){.tbx__row{grid-template-columns:1fr}}

  /* Modal */
  .tbx-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}
  .tbx-modal[hidden]{display:none}
  .tbx-modal__card{width:min(760px,96vw);background:var(--tbx-panel);border:1px solid var(--tbx-border);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.4);outline:0}
  .tbx-modal__head,.tbx-modal__foot{padding:12px 14px;border-bottom:1px solid var(--tbx-border);display:flex;justify-content:space-between;align-items:center}
  .tbx-modal__foot{border-top:1px solid var(--tbx-border);border-bottom:none}
  .tbx-modal__body{padding:12px 14px;max-height:60vh;overflow:auto}
  .tbx-grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .tbx-modal__icon{height:32px;width:32px;border:1px solid var(--tbx-border);background:#121723;color:var(--tbx-muted);border-radius:8px;cursor:pointer}
</style>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const DEFAULT_FIELDS = [
    "scenario_id","da_id","track_id","computed_at","score",
    "cpa_m","tcpa_s","tdb_s","twrp_s",
    "norm_cpa","norm_tcpa","norm_tdb","norm_twrp",
    "w_cpa","w_tcpa","w_tdb","w_twrp",
    "contrib_cpa","contrib_tcpa","contrib_tdb","contrib_twrp"
  ];
  const LS_KEY = "tbx_fields_v1";

  // Modal helpers (open/close, focus trap, ESC)
  const modal = $("tbx-modal");
  const card  = modal.querySelector(".tbx-modal__card");
  let lastFocus = null;

  function openModal(){
    lastFocus = document.activeElement;
    // Load current or defaults into checkboxes
    const saved = loadSavedFields();
    setModalFromFields(($("tbx-use-fields").checked && saved) ? saved : DEFAULT_FIELDS);
    modal.hidden = false;
    card.focus();
    document.addEventListener("keydown", onKey);
    document.addEventListener("focus", trapFocus, true);
  }
  function closeModal(){
    modal.hidden = true;
    document.removeEventListener("keydown", onKey);
    document.removeEventListener("focus", trapFocus, true);
    if (lastFocus && lastFocus.focus) lastFocus.focus();
  }
  function onKey(e){
    if (e.key === "Escape") { e.preventDefault(); closeModal(); }
  }
  function trapFocus(e){
    if (!modal.hidden && !modal.contains(e.target)) {
      e.stopPropagation(); card.focus();
    }
  }

  // Fields persistence
  function readFieldsFromModal(){
    return [...modal.querySelectorAll('[data-col]:checked')].map(i => i.value);
  }
  function setModalFromFields(fields){
    const set = new Set(fields);
    modal.querySelectorAll('[data-col]').forEach(i => i.checked = set.has(i.value));
  }
  function loadSavedFields(){
    try { const raw = localStorage.getItem(LS_KEY); const arr = JSON.parse(raw||"[]"); return Array.isArray(arr)&&arr.length?arr:null; } catch(e){ return null; }
  }
  function saveFields(fields){ localStorage.setItem(LS_KEY, JSON.stringify(fields)); }
  function summarizeFields(fields){
    const max = 4, first = fields.slice(0,max).join(", ");
    return fields.length > max ? `${first} … (+${fields.length-max})` : first;
  }

  function buildUrl(){
    const s = $("tbx-scenario").value.trim();
    const d = $("tbx-da").value.trim();
    const at = $("tbx-at").value.trim();
    const top = $("tbx-topn").value.trim();
    if(!s){ $("tbx-status").textContent = "scenario_id is required"; return null; }
    const p = new URLSearchParams({scenario_id:s});
    if (d) p.set("da_id", d);
    if (at) p.set("at", at);
    if (top) p.set("top_n", top);

    if ($("tbx-use-fields").checked){
      const chosen = loadSavedFields() || DEFAULT_FIELDS;
      if (chosen.length) p.set("fields", chosen.join(","));
    }
    return "/api/tewa/export/threat_board.csv?" + p.toString();
  }

  // Wire up
  $("tbx-fields").addEventListener("click", openModal);
  $("tbx-close").addEventListener("click", closeModal);
  $("tbx-reset").addEventListener("click", () => setModalFromFields(DEFAULT_FIELDS));
  $("tbx-apply").addEventListener("click", () => {
    const fields = readFieldsFromModal();
    saveFields(fields);
    $("tbx-fields-summary").textContent = summarizeFields(fields);
    $("tbx-use-fields").checked = true;
    closeModal();
  });
  $("tbx-export").addEventListener("click", () => {
    $("tbx-status").textContent = "Preparing download…";
    const url = buildUrl();
    if(!url) return;
    const a = document.createElement("a");
    a.href = url; a.rel="noopener"; a.click();
    $("tbx-status").textContent = "";
  });

  // Init summary display
  const saved = loadSavedFields();
  $("tbx-fields-summary").textContent = summarizeFields(saved || DEFAULT_FIELDS);
  $("tbx-use-fields").checked = !!saved;
})();
</script>

<img
  src="/api/tewa/charts/score_history.png?scenario_id={{ scenario.id }}&da_id={{ da.id }}&track_id={{ row.track_id }}&width=800&height=300"
  alt="Score history for {{ row.track_id }}"
  width="800"
  height="300"
/>
